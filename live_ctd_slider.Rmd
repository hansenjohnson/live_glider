---
title: "Live CTD: BOND"
# author: "Hansen Johnson"
# date: "6/7/2017"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
# specify default behaviour for code chunks
knitr::opts_chunk$set(echo = FALSE, warning = F, error = F, message = F)
```

### Summary

This is a simple visualization of CTD data streaming from the current deployment. There is rudimentary processing here, which includes conversion from conductivity to salinity, and density calculation (from salinity, raw pressure, and raw temperature data). There is no quality control; all spurious values are straight from the sensor.

See the following websites for more deployment details: 

WHOI DCS website: <http://dcs.whoi.edu/dal0617_bond/dal0617_bond.shtml>

OTN website: <http://gliders.oceantrack.org/deployments.php?mission_id=73>

```{r code, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, results = 'hide'}

# Set up environment ------------------------------------------------------

rm(list = ls())

# load in various required packages and data
library(data.table, quietly = T, warn.conflicts = F)
library(ggplot2, quietly = T, warn.conflicts = F)
library(plotly, quietly = T, warn.conflicts = F)
library(oce, quietly = T, warn.conflicts = F)
library(ocedata, quietly = T, warn.conflicts = F)
library(cowplot, quietly = T, warn.conflicts = F)
library(plyr, quietly = T, warn.conflicts = F)
library(lubridate, quietly = T, warn.conflicts = F)
library(marmap, quietly = T, warn.conflicts = F)
data(coastlineWorldFine)
load('bathy.rda')


ctd_file = "http://gliders.oceantrack.org/data/live/dal556_sci_water_live.csv"
ctd = fread(ctd_file)

# Manipulate data frame ---------------------------------------------------

# make timestamps intelligable (convert from unixtime)
ctd$time <- as.POSIXct(ctd$unixtime, tz ="America/Halifax", origin = "1970-01-01 00:00:00")

# convert from dbar to bar
ctd$sci_water_pressure = ctd$sci_water_pressure*10

# calculate salinity
ctd$salinity = swSCTp(conductivity = ctd$sci_water_cond, 
                      temperature = ctd$sci_water_temp,
                      pressure = ctd$sci_water_pressure,
                      conductivityUnit = "S/m")

# calculate density
ctd$density = swRho(salinity = ctd$salinity, 
                    temperature = ctd$sci_water_temp, 
                    pressure = ctd$sci_water_pressure)

```

### Plots

Plots generated at: `r Sys.time()`

Latest glider timestamp: `r max(ctd$time)`

Using ctd data from: `r ctd_file`


```{r}

sliderInput(inputId = 'tm',label =  'Glider deployment time', min = min(ctd$time), max = max(ctd$time), value = c(min(ctd$time), max(ctd$time)), step = 60)

```


### Map

```{r map, fig.align='center', fig.height=5, fig.width=5}
renderPlot({
  
subs = subset(ctd, ctd$time >= input$tm[1] & ctd$time <= input$tm[2])

# plotting dimensions
mlon = median(ctd$lon)
mlat = median(ctd$lat)
span = 4 * 111 * diff(range(ctd$lat))

# plot coastline
plot(coastlineWorldFine, clon = mlon, clat = mlat, span = span)

# plot bathymetry
contour(bathyLon,bathyLat,bathyZ,levels = c(-100, -200), lwd = c(2, 2), lty = c(3, 1), drawlabels = TRUE,add = TRUE,col = 'darkgray')

# add bathy legend
legend("bottomright", lwd=c(2,2), lty=c(3,1), col='darkgray', seg.len=3,
       title="Depth [m]", legend=c("100", "200"), bg="white")

# glider track
lines(ctd$lon, ctd$lat, col = 'grey')
lines(subs$lon, subs$lat, col = 'blue')

# begin and end
begin = subs[1,]
points(begin$lon, begin$lat, pch = 17, col = 'darkgreen')
text(begin$lon, begin$lat, labels = begin$time, pos = 4, col = 'darkgreen')

latest = subs[nrow(subs),]
points(latest$lon, latest$lat, pch = 20, col = 'darkred')
text(latest$lon, latest$lat, labels = latest$time, pos = 4, col = 'darkred')

# add glider legend
legend("bottomleft", lty=c(1,NA,NA), pch = c(NA, 17, 20), col = c('blue', 'darkgreen', 'darkred'), c('Track', 'Start', 'Latest'), title = 'Glider')
  
})

```

### Temperature

``` {r section_tinput}
tmin = round(min(ctd$sci_water_temp, na.rm = T), 1)
tmax = round(max(ctd$sci_water_temp, na.rm = T), 1)

sliderInput(inputId = 'tmp',label =  'Choose temperature limits:', min = tmin, max = tmax, value = c(tmin,tmax), step = 0.1)
```

``` {r plot_tsection}
renderPlotly({

subs = subset(ctd, ctd$time >= input$tm[1] & ctd$time <= input$tm[2])

temp = ggplot()+
  geom_point(data = subs, aes(x = time, y = sci_water_pressure, colour = sci_water_temp), na.rm = TRUE)+
  scale_colour_gradientn(colours = oce.colorsTemperature(200), limits = c(input$tmp[1],input$tmp[2])) +
  scale_y_reverse() +
  labs(x = '', y = 'Pressure [dbar]', title = 'Temperature [deg C]', colour = '')+
  theme_bw()

# plot sections
ggplotly(temp)
})
```

### Salinity

``` {r section_sinput}
smin = round(min(ctd$salinity, na.rm = T), 1)
smax = round(max(ctd$salinity, na.rm = T), 1)

sliderInput(inputId = 'sal',label =  'Choose salinity limits:', min = smin, max = smax, value = c(smin,smax), step = 0.01)
```


``` {r plot_ssection}
renderPlotly({

subs = subset(ctd, ctd$time >= input$tm[1] & ctd$time <= input$tm[2])

sal = ggplot()+
  geom_point(data = subs, aes(x = time, y = sci_water_pressure, colour = salinity), na.rm = TRUE)+
  scale_colour_gradientn(colours = oce.colorsSalinity(200), limits = c(input$sal[1],input$sal[2])) +
  labs(x = '', y = 'Pressure [dbar]', title = 'Salinity', colour = '')+
  scale_y_reverse() +
  theme_bw()

# plot sections
ggplotly(sal)
})
```

### Density

``` {r section_dinput}
dmin = round(min(ctd$density, na.rm = T), 1)
dmax = round(max(ctd$density, na.rm = T), 1)

sliderInput(inputId = 'dns',label =  'Choose density limits:', min = dmin, max = dmax, value = c(dmin,dmax), step = 0.01)
```

``` {r plot_dsection}
renderPlotly({

subs = subset(ctd, ctd$time >= input$tm[1] & ctd$time <= input$tm[2])

dens = ggplot()+
  geom_point(data = subs, aes(x = time, y = sci_water_pressure, colour = density),na.rm = T)+
  scale_colour_gradientn(colours = oce.colorsDensity(200), limits = c(input$dns[1],input$dns[2])) +
  labs(x = '', y = 'Pressure [dbar]', title = 'Density [kg/m3]', colour = '')+
  scale_y_reverse() +
  theme_bw()

# plot sections
ggplotly(dens)
})
```
